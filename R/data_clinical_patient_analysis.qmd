---
title: "data_clinical_patient_analysis"
author: "Romane"
format: html
editor: visual
---

# Importing libraries

```{r}
#| echo : False
library("tidyverse")
library('here')
library('survival')
library('survminer')
library('viridis')
```

# Importing data

```{r}
patients_sample_gene_panel <- read_delim(here("data", "patient_sample_gene_panel"), delim = "\t")
```

# Subseting Data

From the merge data set, we will do analysis on the patients information for now, so taking only the columns that were originally in the patient data set, diregarding the cancer types,..

```{r}
patients <- patients_sample_gene_panel |> 
  select(c(SEX, OS_MONTHS, OS_STATUS, AGE_GROUP, DRUG_TYPE)) |> 
  mutate(AGE_GROUP = factor(
      AGE_GROUP,
      levels = c("<30", "31-50", "50-60", "61-70", ">71"),
      ordered = TRUE
      )
      )
```

# Plots

First, we will be looking at the age distribution of Cancers in men and woman and separating the death proprtion from the living ones.

```{r}
patients |>
  ggplot(aes(x = AGE_GROUP,
             fill = factor(SEX))) +
  geom_bar()+
  scale_fill_viridis(option = "viridis",
                     discrete = TRUE,
                     alpha = 0.7)+
  facet_wrap(
  ~OS_STATUS,
  labeller = labeller(OS_STATUS = 
                        c(`0` = "Alive",
                          `1` = "Deceased")
                      ))+
  labs(title="Proportion of Cancer diagnosed in Men and Woman at different ages and their current status", 
       x = "Age group at Diagnosis (years)",
       fill = 'Gender')+
  theme_minimal()+
  theme(plot.title = element_text(size = 9))
```

In both groups, dead or alive, the patients, men and woman that have a cancer diagnosis are usually btween 61-70 years old. Cancers seems to be more diagnosed in man than in woman, at all ages.

Looking more into this age group, lets consider the drug given against cancers.

```{r}
patients |> 
  filter(AGE_GROUP == "61-70") |> 
  ggplot(mapping = aes(x = DRUG_TYPE,
                       fill = SEX))+
  geom_bar()+
  labs(title="Drug given to patients diagnosed with a cancer between 61-70years old, differenciated by male and woman", 
       x = "Drug",
       fill = 'Gender')+
  theme(plot.title = element_text(size = 10))+
  scale_fill_viridis(option = "viridis",
                     discrete = TRUE,
                     alpha = 0.7)

#Comparing it to Patients of All Ages
ggplot(patients, 
       mapping = aes(x = DRUG_TYPE,
                       fill = SEX))+
  geom_bar()+
  scale_fill_viridis(option = "viridis",
                     discrete = TRUE,
                     alpha = 0.7)+
  labs(title="Drug given to patients, of all ages, differenciated by gender", 
       x = "Drug",
       fill = 'Gender')+
  theme_minimal()+
  theme(plot.title = element_text(size = 10))
  
```

```{r}
patients |>
  filter(AGE_GROUP == "61-70") |> 
  ggplot(mapping = aes(x = DRUG_TYPE,
                       y = OS_MONTHS,
                       fill = factor(OS_STATUS)))+
  geom_boxplot()+
  scale_fill_viridis(label = c('Alive', "Desceased"),
                     option = "viridis",
                     discrete = TRUE,
                     alpha = 0.7)+
  
  facet_wrap(~ SEX)+
  labs(title = 'Box Plot of the Drug success rate based on the proportion of patients status, separated by gender', 
       fill = 'Status', 
       x = 'Drug Type against Cancer', 
       y = 'Number of months survived')+
  theme_minimal()+
  theme(plot.title = element_text(size = 10))
```

In General, PDL-1 is given more than other drugs, CTL4 is rarely given and sometimes Combo.

As for the 61-70 agre group, woman given CTLA4, both survived and died the most.

For both men and women PDL-1 has the lowest death proportion. It could be that PDL-1 is generally more given, in cancers tha are less agressive, and combo or CTLA4 for more agressive cancers taht do not react to PDL-1.

## Survival rate

With the patient data, containing Overall Survival months (OS_MONTHS) and Overall Survival Status (OS_STATUS), it is possible to compute a survival probability over time, using the Kaplan Meier method. The Survival package follows this principal and allows us to compute the survival rate of the patients. To do so, Surv() creates the formula object, associating the status of a patients to it's survival time. Then, survfit uses the formula object to fit it to the Kaplan Meier estimator, calculating the survival probabilities at each observed event time. The result can then be used to plot the Kaplanâ€“Meier survival.

```{r}

#Using the Kaplan Meier based survival function: 
KM_f <- survfit(Surv(OS_MONTHS, OS_STATUS) ~1, data = patients)

#convert to a tibble

tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  lower = KM_f$lower,
  upper = KM_f$upper)
print(tibble_KM_f)

ggplot(tibble_KM_f, 
       mapping = aes(x = time,
                     y = survival))+
  geom_step()+
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.3, color = 'blue') +
  coord_cartesian(ylim = c(0,NA))+
  labs(title = 'Overall Survival rate of the patients', 
       x = "Time (in months)",
       y = 'Overall Survival Probability')+
  theme_minimal()
  




```

```{r}

#Using the Kaplan Meier based survival function, declining it to the different sobservations that we can make
#survival rate based on the gender of the patients:


KM_f <- survfit(Surv(OS_MONTHS, OS_STATUS) ~SEX, data = patients)

#convert to a tibble

tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata),KM_f$strata),
  lower = KM_f$lower,
  upper = KM_f$upper)

tibble_KM_f <- tibble_KM_f |> 
  mutate(strata = str_remove(strata, 'SEX ='))

ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  scale_color_viridis_d(label = c('Female', 'Male'), 
                      option = "viridis",
                      alpha = 1)+
  coord_cartesian(ylim = c(0, NA))+
  labs(title = 'Survival Curve of the patients depending on their gender', 
       x ='Time (in Months)',
       y = 'Overall Survival Probability',
       color = 'Gender')+
  theme_minimal()
  
```

```{r}
KM_f <- survfit(Surv(OS_MONTHS, OS_STATUS) ~AGE_GROUP, data = patients)

#convert to a tibble

tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata),KM_f$strata))

tibble_KM_f <- tibble_KM_f %>%
  mutate(strata = str_remove(strata, "AGE_GROUP="))

ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  scale_color_viridis_d(option = "viridis",
                        alpha = 1)+
  coord_cartesian(ylim = c(0, NA))+
  labs(title = 'Survival Curve of the patients depending on their Age at the dignostic', 
       x = 'Time (in Months)',
       y = 'Overall Survival Probability',
       color = 'Age Group')+
    theme_minimal()
```

```{r}
KM_f <- survfit(Surv(OS_MONTHS, OS_STATUS) ~DRUG_TYPE, data = patients)

#convert to a tibble

tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata),KM_f$strata))

tibble_KM_f <- tibble_KM_f %>%
  mutate(strata = str_remove(strata, "DRUG_TYPE="))

ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  scale_color_viridis_d(label = c('CTLA4', 'PD-1/PDL-1', 'Combo'))+
  coord_cartesian(ylim = c(0, NA))+
  labs(title = 'Survival Curve of the patients depending on their Medication', 
       x ='Time (in Months)', 
       y = 'Overall Survival Probability',
       color = 'Drug')+
  theme_minimal()
```

From the course, we can make a Logistic regression model

```{r Logistic Regression Model}
my_glm_mdl <- glm(formula = OS_STATUS ~ OS_MONTHS,
                  family = binomial(link = "logit"),
                  data = patients)
```

```{r}

patients |>
  mutate(my_glm_model = pluck(my_glm_mdl, "fitted.values")) |>
  arrange(OS_MONTHS) |> 
  ggplot(aes(x = OS_MONTHS,
             y = OS_STATUS)) +
  geom_point(alpha = 0.5,
             size = 3)+
  geom_line(aes(y = my_glm_model))+
  labs(title = 'Logistic Regression model of Patients survival in months', 
       x = "Time (in Months)", 
       y = 'Overall Survival Probability')

```

Death rate decreases over time

However, the problem with a GLM, is that it does not take into account the "censored" patients, some patients are alive after 4 months but there is no later update. The data does not follow the patient until the end yet GML assumes it does.
