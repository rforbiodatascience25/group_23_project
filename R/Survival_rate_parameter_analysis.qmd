---
title: "Survival Rate - Multi parameter analysis"
format: html
editor: visual
---

## Loading Libraries

```{r}
library('tidyverse')
library('survival')
library('here')
```

## Loading Data

```{r}
patients_sample_gene_panel <- read.delim(here("data", "patient_sample_gene_panel"), sep = "\t", header = TRUE)


```

## Data Wrangling

```{r}
patients_sample_gene_panel
```

```{r}
patients_sample <- patients_sample_gene_panel |>  
  select(c(SEX, OS_MONTHS, OS_STATUS, AGE_GROUP, DRUG_TYPE, CANCER_TYPE, TMB_NONSYNONYMOUS, AGE_AT_SEQ_REPORT))


```

```{r}
#Comparing the number of mutation, and the drug given, in the case of Glioma cancer
patients_sample <- patients_sample |> 
  mutate(TMB_group = case_when(TMB_NONSYNONYMOUS<5 ~'low TMB',
                               5<=TMB_NONSYNONYMOUS & TMB_NONSYNONYMOUS<20 ~'Intermediate TMB',
                               TMB_NONSYNONYMOUS>=20 ~'high TMB'))

patients_sample |> 
  ggplot(mapping = aes(x = TMB_group,
                       fill = DRUG_TYPE))+
  geom_bar()+
  labs(tile = 'Bar plot of Drug given againts different severity of TMB (Tumor Mutational Burden', x = 'TMB Severity')
```

## Survival Rate Analysis

### By Cancer Type

Does the cancer type affects the survival of patients?

```{r}
library("viridis")
KM_f <- survfit(Surv(OS_MONTHS, OS_STATUS) ~CANCER_TYPE, data = patients_sample)

#convert to a tibble
print(summary(KM_f))
#names(KM_f)
print(KM_f$strata)
tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata), KM_f$strata))
#print(tibble_KM_f)

tibble_KM_f <- tibble_KM_f %>%
  mutate(strata = str_remove(strata, "CANCER_TYPE="))

ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  labs(title = 'Survival Curve of the patients depending on their Cancer type', color = 'Cancer Type')+
  scale_fill_viridis(option = "viridis",
                     discrete = TRUE) 
#hmm why does the cancer type repeats itself?? wrong
  
```

```{r}
ggplot(patients_sample,
       mapping = aes(x = AGE_AT_SEQ_REPORT, 
                     fill = CANCER_TYPE))+
  geom_bar()
```

```{r}
ggplot(patients_sample,
       mapping = aes(x = TMB_group, 
                     fill = CANCER_TYPE))+
  geom_bar()
```

```{r}
ggplot(patients_sample,
       mapping = aes(x = CANCER_TYPE, 
                     fill = Sex))+
  geom_bar()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+scale_fill_viridis(option = "viridis",
                     discrete = TRUE, alpha =0.5) 
```

```{r}
ggplot(patients_sample,
       mapping = aes(x = CANCER_TYPE, 
                     fill = Drug.Type))+
  geom_bar()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

\
select(-c(Age_group)) patients_sample \<- left_join(sample, patients, by = 'Patient_ID'))

#scale_color_discrete(label = factor(tibble_KM_f\$strata))

```{r}
patients_sample_glioma <- patients_sample |> 
  filter(CANCER_TYPE == "Glioma")
```

### By TMB (mutation burden)

```{r}

KM_f <- survfit(Surv(OS_MONTHS, OS_STATUS) ~TMB_group, data = patients_sample_glioma)

#convert to a tibble
#print(summary(KM_f))
names(KM_f)
print(KM_f)
tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata),KM_f$strata))
tibble_KM_f <- tibble_KM_f %>%
  mutate(strata = str_remove(strata, "TMB_group="))
ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  labs(title = 'Survival Curve of the patients depending on their TMB', color = 'TMB severity', )
```

```{r}
KM_f <- survfit(Surv(OS_MONTHS, OS_STATUS) ~TMB_group, data = patients_sample)

#convert to a tibble
#print(summary(KM_f))
names(KM_f)
print(KM_f)
tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata),KM_f$strata))
tibble_KM_f <- tibble_KM_f %>%
  mutate(strata = str_remove(strata, "TMB_group="))
ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  labs(title = 'Survival Curve of the patients depending on their TMB', color = 'TMB severity', )
```

```{r}
#looking at the repartition of TMBs in the different sections
ggplot(patients_sample_glioma, 
       mapping = aes(x = TMB_group))+
  geom_bar()
```

```{r}
ggplot(patients_sample_glioma, 
       mapping = aes(x = (TMB_group), 
                     fill = Drug.Type))+
  geom_bar()
```

```{r}
KM_f <- survfit(Surv(OS_MONTHS, OS_STATUS) ~Sex, data = patients_sample_glioma)

#convert to a tibble
#print(summary(KM_f))
names(KM_f)
print(KM_f)
tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata),KM_f$strata))
tibble_KM_f <- tibble_KM_f %>%
  mutate(strata = str_remove(strata, "TMB_group="))
ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  labs(title = 'Survival Curve of the patients depending on their TMB', color = 'Gender', )
```

KM_f \<- survfit(Surv(Survival_Months, OS_status) \~TMB_group, data = patients_sample_glioma)

```{r}
#convert to a tibble 
#print(summary(KM_f)) names(KM_f) print(KM_f) 
tibble_KM_f <- tibble |> 
  (time = KM_f$time,
  survival = KM_f$surv, 
  strata = rep(names(KM_f$strata),KM_f$strata)) 
tibble_KM_f <- tibble_KM_f %>% 
  mutate(strata = str_remove(strata, "TMB_group=")) 
ggplot(tibble_KM_f, 
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+ 
  geom_step()+ 
  labs(title = 'Survival Curve of the patients depending on their TMB', color = 'TMB severity', )
```

### By mutation number

```{r}

KM_f <- survfit(Surv(OS_MONTHS, OS_STATUS) ~ n_mutation_log, data = patients_sample)


names(KM_f)
print(KM_f)
tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata),KM_f$strata))
print(tibble_KM_f)
ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  labs(title = 'Survival Curve of the patients with a glioma cancer depending on the number of mutations they have (log scale)', color = 'number of mutation')+
  scale_color_discrete(label = factor(patients_sample$n_mutation_log))
```

```{r}
patient_sample_mutation |> 
  filter(CANCER_TYPE == 'Glioma') |> 
  KM_f <- survfit(Surv(OS_MONTHS, OS_STATUS) ~ n_mutation_log)


names(KM_f)
print(KM_f)
tibble_KM_f <- tibble(
  time = KM_f$time,
  survival = KM_f$surv,
  strata = rep(names(KM_f$strata),KM_f$strata))
print(tibble_KM_f)
ggplot(tibble_KM_f,
       mapping = aes(x = time, 
                     y = survival, 
                     color = strata))+
  geom_step()+
  labs(title = 'Survival Curve of the patients with a glioma cancer depending on the number of mutations they have (log scale)', color = 'number of mutation')+
  scale_color_discrete(label = factor(patient_sample_mutations$n_mutation_log))
  
```

Does the number of mutation affect the survival and thus is an indicator of the severity of the cancer?
